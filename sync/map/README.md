### sync.map

å†…å»ºçš„mapä¸æ˜¯çº¿ç¨‹(goroutine)å®‰å…¨çš„

åœ¨å¹¶å‘è¯»å†™è¿‡ç¨‹ä¸­,ä¸‹åˆ—ç¨‹åºä¸­ä¸€ä¸ªgoroutineä¸€ç›´è¯»ï¼Œä¸€ä¸ªgoroutineä¸€åªå†™åŒä¸€ä¸ªé”®å€¼ï¼Œå³å³ä½¿è¯»å†™çš„é”®ä¸ç›¸åŒï¼Œè€Œä¸”mapä¹Ÿæ²¡æœ‰"æ‰©å®¹"ç­‰æ“ä½œï¼Œä»£ç è¿˜æ˜¯ä¼šæŠ¥é”™
![](.README_images/a5350aba.png)

Javaä¸­å­˜åœ¨çš„å¹¶å‘å®‰å…¨çš„Map--`ConcurrentHashMap`
`ConcurrentHashMap`ä½¿ç”¨ç»†ç²’åº¦çš„é”æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯åˆ†æ®µé”ã€‚æ¯ä¸ªåŒºé—´å…±äº«ä¸€æŠŠé”ï¼Œè¿™æ ·å°±å‡å°‘äº†æ‰€æœ‰æ•°æ®éƒ½ç”¨ä¸€æŠŠé”å¸¦æ¥çš„æ€§èƒ½å½±å“

å½“ç„¶åœ¨goä¸­ä¹Ÿæœ‰å¤§ä½¬å®ç°äº† 
[ğŸ”’](https://github.com/orcaman/concurrent-map/blob/master/README-zh.md)

##### sync.Mapçš„æ•°æ®ç»“æ„

```go
type Map struct {
	// å½“æ¶‰åŠåˆ°dirtyæ•°æ®çš„æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªé”
	mu Mutex
	// ä¸€ä¸ªåªè¯»çš„æ•°æ®ç»“æ„ï¼Œå› ä¸ºåªè¯»ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰è¯»å†™å†²çªã€‚
	// æ‰€ä»¥ä»è¿™ä¸ªæ•°æ®ä¸­è¯»å–æ€»æ˜¯å®‰å…¨çš„ã€‚
	// å®é™…ä¸Šï¼Œå®é™…ä¹Ÿä¼šæ›´æ–°è¿™ä¸ªæ•°æ®çš„entries,å¦‚æœentryæ˜¯æœªåˆ é™¤çš„(unexpunged), å¹¶ä¸éœ€è¦åŠ é”ã€‚å¦‚æœentryå·²ç»è¢«åˆ é™¤äº†ï¼Œéœ€è¦åŠ é”ï¼Œä»¥ä¾¿æ›´æ–°dirtyæ•°æ®ã€‚
	read atomic.Value // readOnly
	// dirtyæ•°æ®åŒ…å«å½“å‰çš„mapåŒ…å«çš„entries,å®ƒåŒ…å«æœ€æ–°çš„entries(åŒ…æ‹¬readä¸­æœªåˆ é™¤çš„æ•°æ®,è™½æœ‰å†—ä½™ï¼Œä½†æ˜¯æå‡dirtyå­—æ®µä¸ºreadçš„æ—¶å€™éå¸¸å¿«ï¼Œä¸ç”¨ä¸€ä¸ªä¸€ä¸ªçš„å¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å°†è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºreadå­—æ®µçš„ä¸€éƒ¨åˆ†),æœ‰äº›æ•°æ®è¿˜å¯èƒ½æ²¡æœ‰ç§»åŠ¨åˆ°readå­—æ®µä¸­ã€‚
	// å¯¹äºdirtyçš„æ“ä½œéœ€è¦åŠ é”ï¼Œå› ä¸ºå¯¹å®ƒçš„æ“ä½œå¯èƒ½ä¼šæœ‰è¯»å†™ç«äº‰ã€‚
	// å½“dirtyä¸ºç©ºçš„æ—¶å€™ï¼Œ æ¯”å¦‚åˆå§‹åŒ–æˆ–è€…åˆšæå‡å®Œï¼Œä¸‹ä¸€æ¬¡çš„å†™æ“ä½œä¼šå¤åˆ¶readå­—æ®µä¸­æœªåˆ é™¤çš„æ•°æ®åˆ°è¿™ä¸ªæ•°æ®ä¸­ã€‚
	dirty map[interface{}]*entry
	// å½“ä»Mapä¸­è¯»å–entryçš„æ—¶å€™ï¼Œå¦‚æœreadä¸­ä¸åŒ…å«è¿™ä¸ªentry,ä¼šå°è¯•ä»dirtyä¸­è¯»å–ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå°†missesåŠ ä¸€ï¼Œ
	// å½“missesç´¯ç§¯åˆ° dirtyçš„é•¿åº¦çš„æ—¶å€™ï¼Œ å°±ä¼šå°†dirtyæå‡ä¸ºread,é¿å…ä»dirtyä¸­misså¤ªå¤šæ¬¡ã€‚å› ä¸ºæ“ä½œdirtyéœ€è¦åŠ é”ã€‚
	misses int
}
```

å†™ï¼šç›´å†™dirtyã€‚ è¯»ï¼šå…ˆè¯»readï¼Œæ²¡æœ‰å†è¯»dirtyã€‚
sync.Mapé‡Œæœ‰ä¸¤ä¸ªmapä¸€ä¸ªæ˜¯ä¸“é—¨ç”¨äºè¯»çš„`read map`ï¼Œå¦ä¸€ä¸ªæ˜¯æ‰æ˜¯æä¾›è¯»å†™çš„`dirty map`ï¼›
ä¼˜å…ˆè¯»read mapï¼Œè‹¥ä¸å­˜åœ¨åˆ™åŠ é”ç©¿é€è¯»dirty mapï¼ŒåŒæ—¶è®°å½•ä¸€ä¸ªæœªä»read mapè¯»åˆ°çš„è®¡æ•°ï¼Œå½“è®¡æ•°åˆ°è¾¾ä¸€å®šå€¼ï¼Œå°±å°†read mapç”¨dirty mapè¿›è¡Œè¦†ç›–ã€‚



`dirty`æ˜¯ç›´æ¥åˆ é™¤ï¼Œè€Œ`read`æ˜¯æ ‡è®°åˆ é™¤
é€šè¿‡ç©ºé—´æ¢æ—¶é—´è¿›è¡Œè¯»å†™åˆ†ç¦»

ä¸é€‚ç”¨äºå¤§é‡å†™çš„åœºæ™¯ï¼Œè¿™æ ·ä¼šå¯¼è‡´read mapè¯»ä¸åˆ°æ•°æ®è€Œè¿›ä¸€æ­¥åŠ é”è¯»å–ï¼ŒåŒæ—¶dirty mapä¹Ÿä¼šä¸€ç›´æ™‹å‡ä¸ºread mapï¼Œæ•´ä½“æ€§èƒ½è¾ƒå·®ã€‚




#### éå†
for ... range mapæ˜¯å†…å»ºçš„è¯­è¨€ç‰¹æ€§ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ä½¿ç”¨for rangeéå†sync.Map, ä½†æ˜¯å¯ä»¥ä½¿ç”¨å®ƒçš„Rangeæ–¹æ³•ï¼Œé€šè¿‡å›è°ƒçš„æ–¹å¼éå†
```go
func (m *Map) Range(f func(key, value interface{}) bool) {
	read, _ := m.read.Load().(readOnly)
	// å¦‚æœm.dirtyä¸­æœ‰æ–°æ•°æ®ï¼Œåˆ™æå‡m.dirty,ç„¶ååœ¨éå†
	if read.amended {
		//æå‡m.dirty
		m.mu.Lock()
		read, _ = m.read.Load().(readOnly) //åŒæ£€æŸ¥
		if read.amended {
			read = readOnly{m: m.dirty}
			m.read.Store(read)
			m.dirty = nil
			m.misses = 0
		}
		m.mu.Unlock()
	}
	// éå†, for rangeæ˜¯å®‰å…¨çš„
	for k, e := range read.m {
		v, ok := e.load()
		if !ok {
			continue
		}
		if !f(k, v) {
			break
		}
	}
}
```
